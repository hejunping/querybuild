<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .FilterEditCell:hover{
            background-color: #eeeeee;
        }
        table:hover{
            border: 1px solid #f00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="panle">
            <button class="addColums">ADD</button>
            <button class="getValue">GetValue</button>
            <div class="values">
                <pre></pre>
            </div>
            <div class="FilterOuterTable" id="idFilterTable">
            </div>

            <div class="FilterOuterTable" id="id1">
            </div>
        </div>
    </div>
    <script>
        var buildQuery = function(id){
            this._gwhere = [];
            this.showHtmlId = id;
            this.html_tb = "";
            this._g_remove_group = "";
            this._g_remove_id = "";
            this._gi = 0;
            var that = this;
            this.addColumns = function () {
                var tmp = {}
                if (that._gwhere.length == 0){
                    tmp['linked'] = ""
                }else {
                    tmp['linked'] = "AND"
                }
                tmp['column'] = "Name"
                tmp['value'] = "Rick" + that._gi
                tmp['symbol'] = "等于"
                tmp['id'] = "id_"+ that._gi
                tmp['group'] = []
                that._gwhere.push(tmp)
                $(that.showHtmlId).html(that.addColumnShow(that._gwhere))
                that.html_tb = ""
                that.initGroupClick()
                that._gi++
            }

            // 初始化
            this.initGroupClick = function () {
                // 添加组
                $(".FilterEditOpCell").click(function () {
                    var id = $(this).attr("id")
                    if ($(this).find("a").text()==""){return false;}
                    that._gwhere = that.addGroup(that._gwhere, id)
                    $(that.showHtmlId).html(that.addColumnShow(that._gwhere))
                    that.initGroupClick()
                });

                // 删除组
                $("img[src='columnMenu.png']").click(function () {
                    that._g_remove_group = ""
                    that._g_remove_id = ""
                    var id = $(this).parent().parent().attr("data")
                    that.getRemoveGroup(that._gwhere, id)
                    var pid = that.getPervGroupId(that._g_remove_group)
                    that._gwhere = that.removeGroup(that._gwhere, pid)
                    $(that.showHtmlId).html(that.addColumnShow(that._gwhere))
                    that.initGroupClick()
                });

                // 删除元素
                $("img[src='deleteStep.png']").click(function () {
                    var id = $(this).parent().parent().attr("data")
                    var isgroup = $(this).parent().next().length
                    if (isgroup){
                        that._g_remove_group = ""
                        that._g_remove_id = ""
                        that.getRemoveGroup(that._gwhere, id)
                        var pid = that.getPervGroupId(that._g_remove_group)
                        that._gwhere = that.removeGroup(that._gwhere, pid)
                    }
                    that._gwhere = that.removeItem(that._gwhere, id)
                    $(that.showHtmlId).html(that.addColumnShow(that._gwhere))
                    that.initGroupClick()
                });

                $(".FilterEditCell").mouseover(function(){
                    $(this).children(".FilterEditOpration").css("opacity", 1);
                });
                $(".FilterEditCell").mouseout(function(){
                    $(this).children(".FilterEditOpration").css("opacity", 0);
                });
            };


            // HTML渲染
            this.addColumnShow = (function f(groups, root) {
                var root = root||0
                var html_tb = '<table class="FilterEditTable" cellpadding="0" cellspacing="0"><tbody>';
                for (var i=0;i<groups.length;i++){
                    if (groups[i].group.length){
                        html_tb += '<tr class="FilterEditCell" id="">';
                        html_tb += '<td class="FilterEditOpCell" style="position: static;vertical-align: text-top;" id="'+groups[i].id+'"><a href="javascript:void(null)">'+groups[i].linked+'</a></td>';
                        html_tb += '<td>';
                        html_tb += f(groups[i].group, 1)
                        html_tb += '</td>';
                        html_tb += '</tr>';
                    }else{
                        html_tb += '<tr class="FilterEditCell" id="">';
                        html_tb += '<td class="FilterEditOpCell" style="position: static;vertical-align: text-top;" id="'+groups[i].id+'"><a href="javascript:void(null)">'+groups[i].linked+'</a></td>';
                        html_tb += '<td>';
                        html_tb += '<img border="0" alt="" align="absmiddle" src="obj_filter.png" title="根据列过滤">&nbsp;'+groups[i].column+'<span class="FilterEditValueSpan">&nbsp;'+groups[i].symbol+'</span>&nbsp; <span class="FilterEditValueSpan">'+groups[i].value+'</span>';
                        html_tb += '</td>';
                        html_tb += '<td nowrap="" class="FilterEditOpration" style="opacity: 0;" data="'+groups[i].id+'">';
                        html_tb += '<a href="javascript:void(null)"><img border="0" src="editStep.png" alt="编辑过滤器" title="编辑过滤器" style="margin: 0px 4px;"></a>';
                        html_tb += '<a href="javascript:void(null)"><img border="0" src="deleteStep.png" alt="删除" title="删除" style="margin: 0px 4px;"></a>';
                        if (root){
                            html_tb += '<a href="javascript:void(null)"><img border="0" src="columnMenu.png" alt="编辑过滤器组" title="编辑过滤器组"></a>';
                        }
                        html_tb += '</td>';
                        html_tb += '</tr>';
                    }
                }
                html_tb += '</tbody></table>';
                return html_tb
            });

            // 添加组
            this.addGroup = function (groups, id, ischild) {
                var ischild = ischild||0
                var newgroup = []
                for(var i=0; i<groups.length;i++){
                    var prev = groups[i-1]||{};
                    var curr = groups[i];
                    if (curr['id'] == id) {
                        if (!ischild){
                            var prevLinked = prev['linked']
                            prev['linked'] = ""
                            curr['linked'] = curr['linked'] ? (curr['linked'] == "AND" ? "OR" : "AND") : "";
                            var tmp = {}
                            tmp['column'] = ""
                            tmp['value'] = ""
                            tmp['symbol'] = ""
                            tmp['id'] = "id" + prev['id'].replace("id", "") + curr['id'].replace("id", "")
                            tmp['linked'] = prevLinked
                            tmp['group'] = [prev, curr]
                            newgroup.pop()
                            newgroup.push(tmp)
                        }else{
                            curr['linked'] = curr['linked'] ? (curr['linked'] == "AND" ? "OR" : "AND") : "";
                            newgroup.push(curr)
                        }
                    } else {
                        newgroup.push(curr)
                    }

                    if ( curr['group'].length > 0 ){
                        curr['group'] = this.addGroup(curr['group'], id, 1)
                    }
                }
                return newgroup
            };


            // 获取删除组字段
            this.getRemoveGroup = function (groups, id) {
                for(var i=0; i<groups.length;i++){
                    var curr = groups[i];
                    if ( curr['id'] == id ) {
                        that._g_remove_group = groups
                        break;
                    }
                    if (curr['group']){
                        that.getRemoveGroup(curr['group'], id)
                    }
                }
            };

            // 获取删除组的前一个组的ID
            this.getPervGroupId = function (groups) {
                var id = "id"
                for(var i=0; i<groups.length;i++){
                    id += groups[i]['id'].replace("id", "")
                }
                return id
            };

            // 删除组
            this.removeGroup = function (groups, id) {
                var newgroup = []
                for(var i=0; i<groups.length;i++){
                    var curr = groups[i];
                    if (curr['id'] != id && curr['group'].length>0){
                        curr['group'] = that.removeGroup(curr['group'], id)
                    }
                    if ( curr['id'] == id ) {
                        for(var j=0;j < that._g_remove_group.length;j++){
                            if(curr['linked']) that._g_remove_group[j]['linked'] = curr['linked'];
                            newgroup.push(that._g_remove_group[j])
                        }
                    }else{
                        newgroup.push(curr)
                    }
                }
                return newgroup
            };


            // 删除元素
            this.removeItem = function (groups, id) {
                var newgroup = []
                for(var i=0; i<groups.length;i++){
                    var curr = groups[i];
                    var next = groups[i+1]||0
                    if ( curr['id'] == id ) {
                        if (curr['linked'] == "" && next){
                            groups[i+1]['linked'] = ""
                        }
                    }else{
                        newgroup.push(curr)
                    }
                    if (curr['group'].length>0){
                        curr['group'] = that.removeItem(curr['group'], id)
                        curr['id'] =  "id"
                        for (var j=0; j<curr['group'].length;j++){
                            curr['id'] += curr['group'][j]['id'].replace("id", "")
                        }
                    }
                }
                return newgroup
            };


        }


        //add click
        var h1 = new buildQuery("#idFilterTable")
        $(".addColums").bind("click",function () {
            h1.addColumns()
        })
        
        $(".getValue").bind("click", function () {
            console.log("Values:",h1._gwhere)
            $(".values pre").html(JSON.stringify(h1._gwhere))
        })


        /**

        ////////////////////////////////////////////////////////////
        ////////////////////////////////////////////////////////////

        // 全局变量
        var _gwhere = []
        var html_tb = ""
        var _g_remove_group = ""
        var _g_remove_id = ""
        var _gi = 0
        var showHtmlId = "#idFilterTable"


        var addColumns = function () {
            var tmp = {}
            if (_gwhere.length == 0){
                tmp['linked'] = ""
            }else {
                tmp['linked'] = "AND"
            }
            tmp['column'] = "Name"
            tmp['value'] = "Rick" + _gi
            tmp['symbol'] = "等于"
            tmp['id'] = "id_"+ _gi
            tmp['group'] = []
            _gwhere.push(tmp)
            $(showHtmlId).html(addColumnShow(_gwhere))
            html_tb = ""
            initGroupClick()
            _gi++
        }

        // 初始化
        var initGroupClick = function () {
            // 添加组
            $(".FilterEditOpCell").click(function () {
                var id = $(this).attr("id")
                if ($(this).find("a").text()==""){return false;}
                _gwhere = addGroup(_gwhere, id)
                $(showHtmlId).html(addColumnShow(_gwhere))
                initGroupClick()
            });

            // 删除组
            $("img[src='columnMenu.png']").click(function () {
                _g_remove_group = ""
                _g_remove_id = ""
                var id = $(this).parent().parent().attr("data")
                getRemoveGroup(_gwhere, id)
                var pid = getPervGroupId(_g_remove_group)
                _gwhere = removeGroup(_gwhere, pid)
                $(showHtmlId).html(addColumnShow(_gwhere))
                initGroupClick()
            });

            // 删除元素
            $("img[src='deleteStep.png']").click(function () {
                var id = $(this).parent().parent().attr("data")
                var isgroup = $(this).parent().next().length
                if (isgroup){
                    _g_remove_group = ""
                    _g_remove_id = ""
                    getRemoveGroup(_gwhere, id)
                    var pid = getPervGroupId(_g_remove_group)
                    _gwhere = removeGroup(_gwhere, pid)
                }
                _gwhere = removeItem(_gwhere, id)
                $(showHtmlId).html(addColumnShow(_gwhere))
                 initGroupClick()
            });

            $(".FilterEditCell").mouseover(function(){
                $(this).children(".FilterEditOpration").css("opacity", 1);
            });
            $(".FilterEditCell").mouseout(function(){
                $(this).children(".FilterEditOpration").css("opacity", 0);
            });
        }
        
        // 删除元素
        var removeItem = function (groups, id) {
            var newgroup = []
            for(var i=0; i<groups.length;i++){
                var curr = groups[i];
                var next = groups[i+1]||0
                if ( curr['id'] == id ) {
                    if (curr['linked'] == "" && next){
                        groups[i+1]['linked'] = ""
                    }
                }else{
                    newgroup.push(curr)
                }
                if (curr['group'].length>0){
                    curr['group'] = removeItem(curr['group'], id)
                    curr['id'] =  "id"
                    for (var j=0; j<curr['group'].length;j++){
                        curr['id'] += curr['group'][j]['id'].replace("id", "")
                    }
                }
            }

            return newgroup
        }
        

        // 获取删除组字段
        var getRemoveGroup = function (groups, id) {
            for(var i=0; i<groups.length;i++){
                var curr = groups[i];
                if ( curr['id'] == id ) {
                    _g_remove_group = groups
                    break;
                }
                if (curr['group']){
                    getRemoveGroup(curr['group'], id)
                }
            }
        }

        // 删除组
        var removeGroup = function (groups, id) {
            var newgroup = []
            for(var i=0; i<groups.length;i++){
                var curr = groups[i];
                if (curr['id'] != id && curr['group'].length>0){
                    curr['group'] = removeGroup(curr['group'], id)
                }
                if ( curr['id'] == id ) {
                    for(var j=0;j < _g_remove_group.length;j++){
                        if(curr['linked']) _g_remove_group[j]['linked'] = curr['linked'];
                        newgroup.push(_g_remove_group[j])
                    }
                }else{
                    newgroup.push(curr)
                }
            }
            return newgroup
        }
        
        var getPervGroupId = function (groups) {
            var id = "id"

            for(var i=0; i<groups.length;i++){
                id += groups[i]['id'].replace("id", "")
            }
            return id
        }

        // 添加组
        var addGroup = function (groups, id, ischild) {
            var ischild = ischild||0
            var newgroup = []
            for(var i=0; i<groups.length;i++){
                var prev = groups[i-1]||{};
                var curr = groups[i];
                if (curr['id'] == id) {
                    if (!ischild){
                        var prevLinked = prev['linked']
                        prev['linked'] = ""
                        curr['linked'] = curr['linked'] ? (curr['linked'] == "AND" ? "OR" : "AND") : "";
                        var tmp = {}
                        tmp['column'] = ""
                        tmp['value'] = ""
                        tmp['symbol'] = ""
                        tmp['id'] = "id" + prev['id'].replace("id", "") + curr['id'].replace("id", "")
                        tmp['linked'] = prevLinked
                        tmp['group'] = [prev, curr]
                        newgroup.pop()
                        newgroup.push(tmp)
                    }else{
                        curr['linked'] = curr['linked'] ? (curr['linked'] == "AND" ? "OR" : "AND") : "";
                        newgroup.push(curr)
                    }
                } else {
                    newgroup.push(curr)
                }

                if ( curr['group'].length > 0 ){
                    curr['group'] = addGroup(curr['group'], id, 1)
                }
            }
            return newgroup
        }

        // HTML渲染
        var addColumnShow = (function f(groups, root) {
            var root = root||0
            var html_tb = '<table class="FilterEditTable" cellpadding="0" cellspacing="0"><tbody>';
            for (var i=0;i<groups.length;i++){
                if (groups[i].group.length){
                    html_tb += '<tr class="FilterEditCell" id="">';
                    html_tb += '<td class="FilterEditOpCell" style="position: static;vertical-align: text-top;" id="'+groups[i].id+'"><a href="javascript:void(null)">'+groups[i].linked+'</a></td>';
                    html_tb += '<td>';
                    html_tb += f(groups[i].group, 1)
                    html_tb += '</td>';
                    html_tb += '</tr>';
                }else{
                    html_tb += '<tr class="FilterEditCell" id="">';
                    html_tb += '<td class="FilterEditOpCell" style="position: static;vertical-align: text-top;" id="'+groups[i].id+'"><a href="javascript:void(null)">'+groups[i].linked+'</a></td>';
                    html_tb += '<td>';
                    html_tb += '<img border="0" alt="" align="absmiddle" src="obj_filter.png" title="根据列过滤">&nbsp;'+groups[i].column+'<span class="FilterEditValueSpan">&nbsp;'+groups[i].symbol+'</span>&nbsp; <span class="FilterEditValueSpan">'+groups[i].value+'</span>';
                    html_tb += '</td>';
                    html_tb += '<td nowrap="" class="FilterEditOpration" style="opacity: 0;" data="'+groups[i].id+'">';
                    html_tb += '<a href="javascript:void(null)"><img border="0" src="editStep.png" alt="编辑过滤器" title="编辑过滤器" style="margin: 0px 4px;"></a>';
                    html_tb += '<a href="javascript:void(null)"><img border="0" src="deleteStep.png" alt="删除" title="删除" style="margin: 0px 4px;"></a>';
                    if (root){
                        html_tb += '<a href="javascript:void(null)"><img border="0" src="columnMenu.png" alt="编辑过滤器组" title="编辑过滤器组"></a>';
                    }
                    html_tb += '</td>';
                    html_tb += '</tr>';
                }
            }
            html_tb += '</tbody></table>';
            return html_tb
        })
        **/
    </script>
</body>
</html>